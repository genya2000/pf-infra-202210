AWSTemplateFormatVersion: "2010-09-09"
Description: Template generated by rain

Resources:
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CodeBuildServiceRole
      AssumeRolePolicyDocument: { "Version": "2012-10-17",
        "Statement": [
          {
            "Principal": {
              "Service": "codebuild.amazonaws.com"
            },
            "Action": "sts:AssumeRole",
            "Effect": "Allow" }
        ]
      }
      Description: CodeBuild ServiceRole


  CodeBuildExecuteGitPullPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CodeBuildExecuteGitPullPolicy
      PolicyDocument: {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Action": [
              "codecommit:GetRepository",
              "codecommit:GitPull",
              "codecommit:GetBranch",
              "codecommit:GetCommit",
              "codecommit:UploadArchive",
              "codecommit:GetUploadArchiveStatus",
              "codecommit:CancelUploadArchive",
            ],
            "Effect": "Allow",
            "Resource": "*"
          }
        ]
      }
      Roles:
        - !Ref CodeBuildServiceRole

  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CodePipelineServiceRole
      AssumeRolePolicyDocument: {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Principal": {
              "Service": "codepipeline.amazonaws.com"
            },
            "Action": "sts:AssumeRole",
            "Effect": "Allow"
          }
        ]
      }
      Description: CodePipeline ServiceRole

  CodePipelinePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CodePipelinePolicy
      PolicyDocument: {
        "Statement": [
            {
                "Action": [
                    "codecommit:CancelUploadArchive",
                    "codecommit:GetBranch",
                    "codecommit:GetCommit",
                    "codecommit:GetRepository",
                    "codecommit:GetUploadArchiveStatus",
                    "codecommit:UploadArchive"
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Action": [
                    "cloudwatch:*",
                    "s3:*",
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Action": [
                    "codebuild:BatchGetBuilds",
                    "codebuild:StartBuild",
                    "codebuild:BatchGetBuildBatches",
                    "codebuild:StartBuildBatch"
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Effect": "Allow",
                "Action": [
                    "ecr:DescribeImages"
                ],
                "Resource": "*"
            }
        ],
        "Version": "2012-10-17"
    }
      Roles:
        - !Ref CodePipelineServiceRole
